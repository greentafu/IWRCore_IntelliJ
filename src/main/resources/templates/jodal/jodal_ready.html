<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" class="light-style layout-menu-fixed" dir="ltr" data-theme="theme-default" data-assets-path="../assets/" data-template="vertical-menu-template-free">

<th:block th:replace="~{/layout/mainlayout::all(~{this::#head} ,~{this::#content})}">

    <span id="head">
        <title>자재 관리/ 조달 계획 필요 자재</title>
    </span>

    <span id="content">
        <!-- Content -->
        <div class="container-xxl flex-grow-1 container-p-y">
            <h4 class="fw-bold py-3 mb-4">
                <span class="text-muted fw-light">자재 관리 /</span> 조달 계획 수립
            </h4>

            <div class="card mb-4">
                <div class="card-body">
                    <!-- Buttons for Auto-fill and Bulk Date Registration -->
                    <div class="row mb-4">
                        &nbsp;&nbsp;&nbsp;
                        <button id="auto-fill-button" type="button" class="col-md-2 btn btn-outline-primary" style="width: fit-content;">수량 자동입력</button>&nbsp;
                        <div class="col-md-10">
                            <div class="row">
                                <input id="days-input" type="number" class="form-control col-md-2" placeholder="각 항목 간격 (일)" style="width: 300px;">&nbsp;
                                <button id="bulk-date-button" type="button" class="btn btn-outline-primary col-md-2" style="width: fit-content;">예정일 일괄 등록</button>
                            </div>
                        </div>
                    </div>

                    <!-- Form for Saving Procurement Plan -->
                    <form action="/jodal/save" method="post">
                        <input type="hidden" name="joNo" th:value="${joNo}">
                        <div class="text-nowrap table-responsive">
                            <table class="table table-bordered mb-4">
                                <thead>
                                    <tr>
                                        <th>자재번호</th>
                                        <th>자재명</th>
                                        <th>요청수량</th>
                                        <th>재고수량</th>
                                        <th>1차수량</th>
                                        <th>1차예정일</th>
                                        <th>2차수량</th>
                                        <th>2차예정일</th>
                                        <th>3차수량</th>
                                        <th>3차예정일</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="structure, iterStat : ${structureList}" th:data-index="${iterStat.index}">
                                        <td th:text="${structure.materialDTO.materCode}"></td>
                                        <td th:text="${structure.materialDTO.name}"></td>
                                        <td th:text="${structure.quantity}"></td>
                                        <td>4</td>
                                        <td>
                                            <input type="number" class="quantity-input"
                                                   th:data-row="${iterStat.index}"
                                                   th:name="'quantities[' + ${iterStat.index} + '].firstQuantity'"
                                                   style="border: 0; width: 45px;">
                                        </td>
                                        <td>
                                            <input type="date"
                                                   th:name="'quantities[' + ${iterStat.index} + '].firstDate'"
                                                   style="border: 0; width: 100px;">
                                        </td>
                                        <td>
                                            <input type="number" class="quantity-input"
                                                   th:data-row="${iterStat.index}"
                                                   th:name="'quantities[' + ${iterStat.index} + '].secondQuantity'"
                                                   style="border: 0; width: 45px;">
                                        </td>
                                        <td>
                                            <input type="date"
                                                   th:name="'quantities[' + ${iterStat.index} + '].secondDate'"
                                                   style="border: 0; width: 100px;">
                                        </td>
                                        <td>
                                            <input type="number" class="quantity-input"
                                                   th:data-row="${iterStat.index}"
                                                   th:name="'quantities[' + ${iterStat.index} + '].thirdQuantity'"
                                                   style="border: 0; width: 45px;">
                                        </td>
                                        <td>
                                            <input type="date"
                                                   th:name="'quantities[' + ${iterStat.index} + '].thirdDate'"
                                                   style="border: 0; width: 100px;">
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="d-flex justify-content-between w-100">
                            <a th:href="@{/jodal/list_jodal}">
                                <button type="reset" class="btn btn-outline-secondary">뒤로가기</button>
                            </a>
                            <button type="submit" class="btn btn-primary">등록</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Script Section -->
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    document.getElementById('auto-fill-button').addEventListener('click', function() {
                        document.querySelectorAll('tr[data-index]').forEach(row => {
                            const index = row.getAttribute('data-index');

                            // 자재 수량 추출
                            const quantityText = row.querySelector('td:nth-child(3)').innerText;
                            const quantity = parseFloat(quantityText) || 0;

                            // 재고 수량 추출
                            const stockText = row.querySelector('td:nth-child(4)').innerText;
                            const stock = parseFloat(stockText) || 0;

                            // 계산
                            const result = quantity - stock;
                            const eachQuantity = Math.floor(result / 3); // 소수점을 버리고 정수 부분만 사용
                            const remainder = result % 3; // 나머지 값

                            // 각 입력 필드에 값 설정
                            row.querySelector(`input[name="quantities[${index}].firstQuantity"]`).value = eachQuantity;
                            row.querySelector(`input[name="quantities[${index}].secondQuantity"]`).value = eachQuantity;

                            // 나머지 값을 마지막 필드에 추가
                            const thirdQuantity = eachQuantity + remainder;
                            row.querySelector(`input[name="quantities[${index}].thirdQuantity"]`).value = thirdQuantity;
                        });
                    });
                });
            </script>
        </div>
    </span>
</th:block>
</html>
